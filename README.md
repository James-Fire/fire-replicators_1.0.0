Not complete, but it mostly works.
